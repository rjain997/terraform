name: Terraform Destroy

on:
  workflow_dispatch:
  
jobs:
  terraform-job:
    runs-on: mine
    permissions:
        contents: write

    steps:
      - name: Install Terraform
        run: |
          sudo apt-get update && sudo apt-get install -y gnupg software-properties-common
          wget -O- https://apt.releases.hashicorp.com/gpg | \
          gpg --dearmor | \
          sudo tee /usr/share/keyrings/hashicorp-archive-keyring.gpg > /dev/null
          gpg --no-default-keyring \
          --keyring /usr/share/keyrings/hashicorp-archive-keyring.gpg \
          --fingerprint
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(grep -oP '(?<=UBUNTU_CODENAME=).*' /etc/os-release || lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
          sudo apt update
          sudo apt-get install terraform

      - name: Check version
        run: terraform --version

      - name: AZ Login
        run: az login --service-principal --username ${{ vars.AZ_APPID }} --password ${{ secrets.AZ_PASSWORD }} --tenant ${{ secrets.AZ_TENANT }}

      - name: AZ account show
        run: az account show

      - name: Clone repo
        uses: actions/checkout@v4
        
      - name: Run terraform commands
        run: |
          terraform init
          terraform destroy --auto-approve
          

      - name: Commit
        run: |
            git config --global user.name "rjain997"
            git config --global user.email "rithikjain24@hotmail.com"
            git add terraform.tfstate
            git commit -m "Update Terraform Stateee"
            git push 




